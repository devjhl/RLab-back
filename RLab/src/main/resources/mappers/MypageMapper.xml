<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="kr.kh.RLab.dao.MypageDAO">
<!-- 나의 스크랩 -->
<resultMap id="scrap" type="kr.kh.RLab.vo.BoardVO">
	<id property="bo_num" column="bo_num"/>
	<id property="bo_st_num" column="bo_st_num"/>
	<id property="bo_title" column="bo_title"/>
	<id property="st_name" column="st_name"/>
	<id property="bo_me_id" column="bo_me_id"/>
	<id property="me_name" column="me_name"/>
	<id property="bo_reg_date" column="bo_reg_date"/>
		<association property="scrapVO" javaType="kr.kh.RLab.vo.ScrapVO">
			<result property="sc_num" column="sc_num"/>	
		</association>
</resultMap>

<!-- 나의 모집글  -->
<resultMap id="gather" type="kr.kh.RLab.vo.StudyVO">
	<id property="st_num" column="st_num"/>
	<id property="st_re_name" column="st_re_name"/>
	<id property="st_now_people" column="st_now_people"/>
	<id property="st_total_people" column="st_total_people"/>
	<id property="st_state" column="st_state"/>
		<collection property="gatherVO" column="st_num" select="selectGather" ofType="kr.kh.RLab.vo.GatherVO"></collection>		
</resultMap>

<!-- 마이페이지 홈 > 나의 스터디  -->
<resultMap id="studyMember" type="kr.kh.RLab.vo.StudyVO">
	<id property="st_num" column="st_num"/>
	<id property="st_name" column="st_name"/>
	<id property="st_re_name" column="st_re_name"/>
	<id property="st_now_people" column="st_now_people"/>
	<id property="st_total_people" column="st_total_people"/>
	<id property="st_image" column="st_image"/>
	<id property="st_state" column="st_state"/>
		<association property="studyMemberVO" javaType="kr.kh.RLab.vo.StudyMemberVO">
			<result property="sm_me_id" column="sm_me_id"/>	
			<result property="sm_st_num" column="sm_st_num"/>	
		</association>
</resultMap>


	<!-- [마이페이지 홈] -->
		<!-- 이용 시간 -->
		<select id="selectRes" resultType="kr.kh.RLab.vo.ReservationVO">
			SELECT *
			FROM reservation
			WHERE re_me_id = #{userId};		
		</select>
		
		<!-- 펫 경험치 -->
		<select id="selectPetEx" resultType="kr.kh.RLab.vo.GrowthVO">
			SELECT 
			* FROM growth
		    join exp on ex_level = gr_level
		    where gr_me_id = #{userId};
		</select>
		
		<select id="selectLevelUpExp" resultType="int">
			SELECT ex_experience
			FROM exp
			where ex_level = #{currentLevel};
		</select>
		
		<update id="updateExp">
			update growth
			set gr_exp = #{currentEx}
			where gr_me_id = #{userId};
		</update>
		
		<!-- 적립 포인트 -->
		<select id="selectMyPoint" resultType="int">
			SELECT me_point
			FROM member
			WHERE me_id = #{userId};		
		</select>
		
		<!-- 나의 예약 -->
		<select id="selectResList" resultType="kr.kh.RLab.vo.ReservationVO">
			SELECT *
			FROM reservation
			WHERE re_me_id = #{userId};		
		</select>
		
		<!-- 나의 스터디 -->
		<select id="selectMainStudyList" resultMap="studyMember">
			select st_num, sm_st_num, st_name, st_me_id, st_name, st_image
			from study_member
			join study on sm_st_num = st_num
			where sm_me_id = #{userId}
			ORDER BY sm_num DESC
			LIMIT 3
		</select>
		
		<!-- 나의 스크랩 -->
		<select id="selectMainScrapList" resultMap="scrap">
			select st_name, bo_title, bo_st_num, bo_num,  sc_num
  			from board
  			join study on bo_st_num = st_num
            join scrap on bo_num = sc_bo_num
			WHERE  
				sc_me_id = #{userId} 
				and sc_state = 1
			ORDER BY bo_num DESC
			LIMIT 4		
		</select>
		
		

	<!-- [개인정보 수정 > 비밀번호 체크 > 개인정보 수정창] -->
		<!-- 프로필 이미지 수정 -->
		<update id="updateProfile">
		  UPDATE member
		  SET me_profile = #{m.me_profile}
		  WHERE me_id = #{m.me_id}
		</update>
		
		<!-- 나머지 개인정보 수정 -->
		<update id="updateMember">
		  UPDATE member
		  SET me_name = #{m.me_name},
		      me_pw = #{m.me_pw},
		      me_email = #{m.me_email}
		  WHERE me_id = #{m.me_id}
		</update>


	<!-- [작성글 관리 > 나의 게시글] -->
		<!-- 아이디로 작성 게시글 목록 가져오기  -->
	  	<select id="selectBoardListById" resultType="kr.kh.RLab.vo.BoardVO">
	 		SELECT board.bo_num, study.st_name, board.bo_title, member.me_name, board.bo_reg_date 
	 		FROM board
	 		JOIN study ON board.bo_st_num = study.st_num
	 		JOIN member ON board.bo_me_id = member.me_id
	 		where board.bo_me_id = #{memberId}
	 		ORDER BY board.bo_reg_date DESC 
	 		limit #{cri.pageStart}, #{cri.perPageNum}
	  	</select>
	  	
	  	<!-- 로그인한 회원이 작성한 게시글 전체 수 가져오기  -->
	  	<select id="selectPostBoardTotalCount" resultType="int">
	  		select count(*)
			from board
			where bo_me_id = #{memberId}
	  	</select>
		
		
  	<!-- [작성글 관리 > 나의 스크랩] -->
  		<!-- 아이디로 스크랩한 게시글 목록 가져오기  -->	
  		<select id="selectScrapListById" resultMap="scrap">
		    SELECT sc_num, st_name, bo_title, bo_num, me_name, bo_reg_date
			FROM board
			JOIN study ON board.bo_st_num = study.st_num
		    JOIN member ON board.bo_me_id = member.me_id
			JOIN scrap ON board.bo_num = scrap.sc_bo_num
			WHERE scrap.sc_me_id = #{memberId} AND scrap.sc_state = 1
			limit #{cri.pageStart}, #{cri.perPageNum}
   		</select>
   		
    	<!-- 로그인한 회원이 스크랩한 게시글 전체 수 가져오기  -->	
	    <select id="selectScrapBoardTotalCount" resultType="int">
	  		select
				count(*)
				from scrap
				where sc_me_id = #{memberId}
	  	</select>
	  	
			
	  	
	<!-- [작성글 관리 > 나의 모집글] -->
  		<!-- 아이디로 내가 쓴 모집글 가져오기 -->	
  		<select id="selectGatherListById" resultMap="gather">
  			select ga_num, ga_title, ga_me_id, me_name,
  				st_num, st_image, st_re_name, st_now_people, st_total_people, st_state
  			from study
  			join gather on ga_st_num = st_num
  			join member on me_id = st_me_id
			WHERE  
				ga_me_id = #{memberId}
			<if test="gatherCri.filter == 'on'">
				AND st_state = 1
			</if>
			ORDER BY ga_num DESC
			limit #{gatherCri.pageStart}, #{gatherCri.perPageNum}
		</select>
		
  		<!-- 내가 쓴 모집글 스터디의 태그들 가져오기 -->		
		<select id="selectTagListById" resultType="kr.kh.RLab.vo.TagRegisterVO">
			select 	* from tag_register
		</select>
		
		<!-- 로그인한 회원이 작성한 모집글 전체 수 가져오기 -->	
	    <select id="selectGatherTotalCount" resultType="int">
	  		select
				count(*)
				from gather
				where ga_me_id = #{memberId}
	  	</select>
	  	
		<select id="selectGather" resultType="kr.kh.RLab.vo.GatherVO">
			select * 
				from gather
				where ga_st_num = #{st_num}
		</select>
		
		<!-- 내가 쓴 모집글의 찜 여부 가져오기 -->
		<select id="selectWantListById" resultType="Integer">
			SELECT ga_st_num 
				FROM want 
				join gather on ga_num = wa_ga_num
				where wa_state=1 and wa_me_id = #{me_id}
		</select>
		
		<!--  내 펫 정보가져오기 -->
		<select id="selectMyPet" resultType="kr.kh.RLab.vo.GrowthVO">
			select * from growth
				join pet on  pe_num = gr_pe_num
				join evolution on ev_num = gr_ev_num
				where gr_me_id = #{me_id};
		</select>
		
		<!-- 내 펫 경험치가져오기 -->
		<select id="selectPetExp" resultType="kr.kh.RLab.vo.GrowthVO">
			select * from growth 
				join pet on gr_pe_num = pe_num
				join exp on pe_final_level = ex_level
				where gr_me_id = #{me_id};
		</select>
</mapper>